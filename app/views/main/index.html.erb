<% if current_user.teacher? %>
  <%= link_to main_prev_path, method: :patch do %><i class="fa fa-5x fa-angle-left"></i><% end %>
  <%= link_to main_next_path, method: :patch do %><i class="fa fa-5x fa-angle-right"></i><% end %>
<% end %>
<h1 class="day"><%= current_user.today.strftime('%A') %></h1>
<h2 class="date"><%= current_user.today.strftime('%B %e') %></h2>
<% if current_user.student? %>
  <%= link_to new_request_path do %><div class="add">Add Friends</div><% end %>
  <% (0..5).each do |i| %>
    <p class="sub" style="position:relative; left: 70px; font-size: 28px;"><%= @departments[i] %> Department</p>
    <% @users.where(dept: i).order('last ASC').each do |teacher| %>
      <% unless @rooms.where(user_id: teacher.id, occurs: current_user.today).first.nil? %>
        <% room = @rooms.where(user_id: teacher.id, occurs: current_user.today).first %>
        <div class="card card-<%= room.id %>">
          <h1 class="card-header header-<%= room.id %>"><%= teacher.last %></h1>
          <p class="room sub grey-<%= room.id %>">RM <%= teacher.room %></p>
          <h2 class="class class-<%= room.id %>"><%= room.name %></h2>
          <p class="text grey-<%= room.id %>"><%= room.desc %></p>
          <% friends = 0 %>
          <% friendarr = [] %>
          <% unless current_user.friend == [] %>
            <% eval(current_user.friend).each do |friend| %>
              <% if User.find_by_id(friend).class_id == room.id %>
                <% friends += 1 %>
                <% friendarr.push(User.find_by_id(friend).first) %>
              <% end %>
            <% end %>
          <% end %>
          <% if current_user.class_id != room.id && friends > 0 %>
            <% if friends == 1 %>
              <p class="friend"><%= friends %> friend is attending this</p>
            <% else %>
              <p class="friend"><%= friends %> friends are attending this</p>
            <% end %>
          <% end %>
          <p class="remaining left-<%= room.id %>">
            <% if current_user.class_id == room.id %>
              ATTENDING
            <% elsif (room.capacity - @users.where(class_id: room.id).count) == 0 %>
              FULL
            <% else %>
              <%= room.capacity - @users.where(class_id: room.id).count %> slots left
            <% end %>
          </p>
        </div>
        <% unless (room.capacity - @users.where(class_id: room.id).count) == 0 || current_user.class_id == room.id %>
          <div class="signup-card signup-<%= room.id %>">
            <p class="friends">
              <% friendarr.each_with_index do |friend,index| %>
                <%= friend %><% unless index == friendarr.size - 1 %>, <% end %>
              <% end %>
            </p>
            <%= link_to signup_room_path(room.id), method: :patch do %><p class="attend">ATTEND</p><% end %>
          </div>
        <% end %>
      <% end %>
    <% end %>
  <% end %>
<% else %>
  <% unless @rooms.exists?(user_id: current_user.id, occurs: current_user.today) %>
    <%= form_with(model: @room) do |form| %>

      <%= form.hidden_field :user_id, value: current_user.id %>

      <div class="field">
        <%= form.text_field :name, placeholder: "MTSS Name", class: "input" %>
      </div>

      <div class="field">
        <%= form.number_field :capacity, placeholder: "Capacity",class: "input" %>
      </div>

      <div class="field">
        <%= form.text_field :desc, placeholder: "Description", class: "input" %>
      </div>

      <%= form.hidden_field :occurs, value: current_user.today %>

      <div class="actions">
        <%= form.submit "Submit", class: "submit" %>
      </div>
    <% end %>
  <% else %>
    <% room = @rooms.where(user_id: current_user.id, occurs: current_user.today).first %>
    <% if room.occurs == Date.today %>
      <p class="sub" style="position:relative; left: 110px; font-size: 30px;">Attendance</p>
      <% User.where(class_id: room.id).each do |student| %>
        <% if student.absent? && room.occurs == Date.today %>
          <%= link_to absent_path(student), method: :patch do%><div class="attendance"><p class="atext red"><%= student.first %> <%= student.last %></p></div><% end %>
        <% elsif !student.absent? && room.occurs == Date.today %>
          <%= link_to absent_path(student), method: :patch do%><div class="attendance"><p class="atext"><%= student.first %> <%= student.last %></p></div><% end %>
        <% end %>
      <% end %>
    <% else %>
    <p class="sub" style="position:relative; left: 110px; font-size: 30px;">Your MTSS</p>
      <div class="card">
        <h1 class="card-header"><%= current_user.last %></h1>
        <p class="room sub">RM <%= current_user.room %></p>
        <h2 class="class"><%= room.name %></h2>
        <p class="text"><%= room.desc %></p>
      </div>
    <% end %>
  <% end %>
<% end %>
<script>
  $(document).ready(function() {
    $('.attendance').click(function(){
      $(this).css('background-color','#ff534d');
      $('.atext').css('color','#fff');
    });
    <% @rooms.each do |room| %>
      $('.card-<%= room.id %>').click(function() {
        $('.signup-card').animate({
                          bottom: "190px",
                          "margin-bottom": "-150px"
                        },300 );
        if ($('.signup-<%= room.id %>').css("bottom") != "90px") {
          $('.signup-<%= room.id %>').animate({
                            bottom: "90px",
                            "margin-bottom": "-50px"
                          },300 );
        }else {
          $('.signup-<%= room.id %>').animate({
                            bottom: "190px",
                            "margin-bottom": "-150px"
                          },300 );
        }
      });
    <% end %>
  });
</script>
<style>
html {
  left: 0px;
  padding: 0;
  margin: 0;
  overflow-x: hidden;
}
  body {
    background-color: #fafafa;
  }
  .fa {
    position: absolute;
    font-size: 100px;
    color: #3c73ff;
    top: 160px;
  }
  .fa-angle-left {
    left: 180px;
  }
  .fa-angle-right {
    right: 180px;
  }
  .day {
    font-family: 'HKGrotesk-Bold';
    font-size: 70px;
    text-align: center;
    margin-top: 150px;
    color: #3c73ff;
    text-transform: uppercase;
    letter-spacing: 4px;
  }
  .date {
    font-family: 'HKGrotesk-Semi';
    font-size: 55px;
    text-align: center;
    margin-top: 20px;
    color: #3c73ff;
    letter-spacing: 2px;
    margin-bottom: 150px;
  }
  .sub {
    font-family: 'HKGrotesk-Medium';
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: #b4b4b4;
  }
  .card {
    width: 700px;
    height: 300px;
    background-color: #fff;
    border-radius: 20px;
    position: relative;
    left: 50%;
    margin-left: -400px;
    padding: 50px;
    -webkit-box-shadow: 4px 4px 34px 0px rgba(125,125,125,0.1);
    -moz-box-shadow: 4px 4px 34px 0px rgba(125,125,125,0.1);
    box-shadow: 4px 4px 34px 0px rgba(125,125,125,0.1);
    z-index: 2;
    margin-bottom: 30px;
  }
  .signup-card {
    width: 700px;
    height: 50px;
    background-color: #3c73ff;
    border-radius: 20px;
    left: 50%;
    margin-left: -400px;
    padding: 50px;
    -webkit-box-shadow: 4px 4px 34px 0px rgba(125,125,125,0.1);
    -moz-box-shadow: 4px 4px 34px 0px rgba(125,125,125,0.1);
    box-shadow: 4px 4px 34px 0px rgba(125,125,125,0.1);
    position: relative;
    z-index: 1;
    margin-bottom: -150px;
    bottom: 190px;
  }
  .card:last-child {
    opacity: .99;
  }
  .room {
    float: right;
    position: relative;
    bottom: 75px;
    font-size: 24px;
  }
  .card-header {
    font-family: 'HKGrotesk-Semi';
    font-size: 55px;
    color: #000;
  }
  .class {
    font-family: 'HKGrotesk-Semi';
    font-size: 30px;
    text-transform: uppercase;
    color: #3c73ff;
    letter-spacing: 1px;
    margin-top: 60px;
  }
  .text {
    font-family: 'HKGrotesk-Medium';
    font-size: 25px;
    line-height: 25px;
    margin-top: 20px;
    color: #666;
  }
  .remaining {
    font-family: 'HKGrotesk-Semi';
    font-size: 25px;
    margin-top: 20px;
    position: absolute;
    right: 50px;
    bottom: 20px;
    color: #3c73ff;
  }
  .friend {
    font-family: 'HKGrotesk-Medium';
    font-size: 25px;
    margin-top: 20px;
    position: absolute;
    left: 50px;
    bottom: 20px;
    color: #b4b4b4;
  }

  .attend {
    font-family: 'HKGrotesk-Medium';
    font-size: 25px;
    margin-top: 20px;
    letter-spacing: 1px;
    position: absolute;
    right: 50px;
    bottom: 10px;
    color: #fff;
  }

  .friends {
    font-family: 'HKGrotesk-Medium';
    font-size: 22px;
    margin-top: 20px;
    letter-spacing: 2px;
    position: absolute;
    left: 70px;
    bottom: 15px;
    color: #fff;
  }
  .attendance {
    width: 750px;
    height: 160px;
    margin-left: -375px;
    left: 50%;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    border-radius: 600px;
    background-color: #fff;
    -webkit-box-shadow: 4px 4px 34px 0px rgba(125,125,125,0.1);
    -moz-box-shadow: 4px 4px 34px 0px rgba(125,125,125,0.1);
    box-shadow: 4px 4px 34px 0px rgba(125,125,125,0.1);
  }
  .atext {
    text-align: center;
    font-size:60px;
    color: #3c73ff;
    font-family: 'HKGrotesk-Medium';
    letter-spacing: 5px;
  }
    .red{
    color: #ff534d;
  }
  .add {
      margin-bottom: 50px;
      text-transform: uppercase;
      width: 400px;
      margin-left: -200px;
      left: 50%;
      position: relative;
      height: 100px;
      background-color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      border-radius: 150px;
      color:#3c73ff;
      font-size: 35px;
      font-family: 'HKGrotesk-Semi';
      letter-spacing: 5px;
      -webkit-box-shadow: 4px 4px 34px 0px rgba(125,125,125,0.2);
      -moz-box-shadow: 4px 4px 34px 0px rgba(125,125,125,0.2);
      box-shadow: 4px 4px 34px 0px rgba(125,125,125,0.2);
    }

  <% @rooms.each do |room| %>
    <% if current_user.class_id == room.id %>
      .card-<%=room.id %> {
        background-color: #3c73ff;
      }
      .header-<%=room.id %> {
        color: #fff;
      }
      .class-<%=room.id %> {
        color: #fff;
      }
      .grey-<%=room.id %> {
        color: #fff;
        opacity: .5;
      }
      .left-<%=room.id %> {
        color: #fff;
        font-family: 'HKGrotesk-Medium';
        letter-spacing: 2px;
      }
    <% elsif (room.capacity - @users.where(class_id: room.id).count) == 0 %>
      .class-<%=room.id %> {
        color: #ff534d;
      }
      .left-<%=room.id %> {
        color: #ff534d;
        font-family: 'HKGrotesk-Medium';
        letter-spacing: 2px;
      }
    <% end %>
  <% end %>
</style>
